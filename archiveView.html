<!DOCTYPE html>

<style>
    body {
        margin: 0;
        background-color: #23272a;
        color: white;
        font-family: "Bahnschrift Light";
    }

    .title-box {
        background-color: #23272a;
        position: sticky;
        top: 0px;
        display: flex;
        flex-direction: column;
        border-bottom: #3e4244 1px solid;
    }

    .title-box-grid {
        display: grid;
        align-items: center;
        grid-template-columns: 1fr 0.1fr;
        grid-template-rows: 1fr;
        grid-gap: 10px;
        margin-left: 2%;
        margin-right: 2%;
        margin-bottom: 1%;
        margin-top: 0.5%;
    }

    .refresh-entry-info {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .content-grid {
        align-content: flex-start;
        display: grid;
        max-width: 100vw;
        grid-gap: 20px;
        margin: 2%;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        grid-template-rows: repeat(auto-fill, minmax(300px, 1fr));
    }

    .content {
        flex-direction: column;
        background-color: #404abe;
        border-radius: 1rem;
        overflow: hidden;
        margin-bottom: auto;
    }

    .user-box {
        display: flex;
        flex-direction: row;
        align-items: center;
        margin-left: 10px;
        margin-top: 5px;
    }

    .avatar-image {
        border-radius: 55%;
        width: 2.5rem;
        height: 2.5rem;
        vertical-align: middle;
    }

    .username-text {
        font-weight: bold;
        justify-content: left;
        margin-left: 10px;
        display: inline-block;
    }

    .content-text {
        text-align: center;
        margin-left: 15px;
        margin-right: 15px;
        margin-bottom: 15px;
        margin-top: 5px;
        line-height: 1.5;
        overflow-wrap: break-word;
    }

    .refresh-button {
        width: 2.5rem; 
        height: 2.5rem; 
        background-color: #404abe; 
        border: none; 
        outline: none; 
        border-radius: 50%; 
        cursor: pointer;
    }

    .refresh-button:hover {
        background-color: #5865f2;
    }

    .javascript-error-background {
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        position: fixed;
        background-color: #23272a;
    }

    .javascript-error {
        display: flex;
        color: rgb(180, 46, 46);
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        background-color: white;
        padding: 1.5rem;
        margin: 1.5rem;
        border-radius: 1rem;
    }

    ::-webkit-scrollbar {
        width: 0.6em;
    }

    ::-webkit-scrollbar-track {
        background: #1e2124;
        border-radius: 50px;
    }

    ::-webkit-scrollbar-thumb {
        background: #3e4244;
        border-radius: 50px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #404abe;
    }

    .image-grid {
        display: grid;
        overflow: hidden;
        margin-bottom: auto;
        align-content: flex-start;
    }

    .image-grid-item {
        display: flex;
        overflow: hidden;
        margin-bottom: auto;
    }

    @keyframes button-loading-spinner {
        from {
            transform: rotate(0turn);
        }

        to {
            transform: rotate(-1turn);
        }
    }

    .button-loading-spinner {
        animation: button-loading-spinner 1s ease infinite;
    }

</style>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ArchiveWeb - <%= archiveName %></title>
    </head>

    <noscript>
        <div class="javascript-error-background">
            <div class="javascript-error">
                This web app requires JavaScript to be enabled in order to function properly.<br>
                Please enable JavaScript in your browser settings or unblock scripts, and try again.
            </div>
        </div>
    </noscript>

    <script language="JavaScript" type="text/javascript" src="/js/jquery-3.6.3.min.js"></script>

    <script>
        function refresh() {
            const refreshButton = document.querySelector(".refresh-button");
            // disable the refresh button for more clicks
            refreshButton.disabled = true;
            // set the style so that it is no longer a pointer cursor
            refreshButton.style.cursor = "default";
            // remove the hover effect
            refreshButton.style.backgroundColor = "#404abe";

            // add a loading spinner to the refresh button
            refreshButton.classList.add("button-loading-spinner");
            
            // send a POST request to the server to refresh the archive
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/refresh-archive", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify({
                archiveName: "<%= archiveName %>"
            }));

            // wait for the server to respond with a 200 OK
            xhr.onreadystatechange = function() {
                if (xhr.status == 200) {
                    // reload the page
                    location.reload();
                }
            }
        }

        function loadImages() {
            const images = document.querySelectorAll(".media-image");
    
            const options = {
            root: null,
            rootMargin: "0px",
            threshold: 0
            };
    
            const observer = new IntersectionObserver(onIntersection, options);
    
            images.forEach(image => {
            observer.observe(image);
            });
    
            function onIntersection(entries) {
                entries.forEach(entry => {
                if (entry.intersectionRatio > 0) {
                    entry.target.src = entry.target.dataset.src;
                    observer.unobserve(entry.target);
                }
                });
            }
        }

        function loadVideos() {
            const sources = document.querySelectorAll(".media-video");

            const options = {
                root: null,
                rootMargin: "0px",
                threshold: 0
            };

            const observer = new IntersectionObserver(onIntersection, options);

            sources.forEach(source => {
                observer.observe(source);
            });

            function onIntersection(entries) {
                entries.forEach(entry => {
                if (entry.intersectionRatio > 0) {
                    entry.target.src = entry.target.dataset.src;
                    observer.unobserve(entry.target);
                }
                });
            }
        }

        function checkAvatarImages() {
            // if avatar images are not loaded, use the default image
            const avatarImages = document.querySelectorAll('.avatar-image');
            var avatarArray = [...avatarImages];

            avatarArray.forEach(avatarImage => {
                // do a async request to check if the image exists
                var xhr = new XMLHttpRequest();
                xhr.open("HEAD", avatarImage.src, true);
                xhr.send();

                xhr.onreadystatechange = function() {
                    if (this.readyState == this.DONE) {
                        if (this.status == 404) {
                            avatarImage.src = "/assets/default-avatar.png";
                        }
                    }
                }
            });
        }

        function moveImages() {
            const imageGrid = document.querySelectorAll('.image-grid');
            var gridArray = [...imageGrid];

            gridArray.forEach(imageGrid => {
                const imageGridItems = imageGrid.querySelectorAll('.image-grid-item');
                const numberOfImages = imageGridItems.length;
                
                if (numberOfImages === 1) {
                    imageGrid.style.gridTemplateColumns = '1fr';
                } else if (numberOfImages === 2) {
                    imageGrid.style.gridTemplateColumns = '1fr 1fr';
                } else if (numberOfImages === 3) {
                    imageGrid.style.gridTemplateColumns = '1fr 1fr';
                    imageGrid.style.gridTemplateRows = '1fr ' + imageGridItems[2].clientHeight - 1 + 'px';
                    imageGridItems[0].style.gridColumn = '1 / 3';
                } else if (numberOfImages === 4) {
                    imageGrid.style.gridTemplateColumns = '1fr 1fr';
                    imageGrid.style.gridTemplateRows = '1fr ' + imageGridItems[2].clientHeight - 1 + 'px';
                } else {
                    imageGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(150px, 1fr))';
                }

                imageGridItems.forEach(imageGridItem => {
                    // stretch the image to fit the grid
                    imageGridItem.style.width = '100%';
                    imageGridItem.style.height = '100%';
                });
            });
        }
    </script>

    <body onload="checkAvatarImages(), loadImages(), loadVideos(), moveImages()">
        <div class="title-box">
            <!-- create a grid of 1 row 2 columns that has the h1 and p in one side the button and entrycount in the other -->
            <div class="title-box-grid">
                <div>
                    <h1><%= archiveName %></h1>
                </div>
                <div>
                    <div class="refresh-entry-info">
                        <p id="entrycount" style="text-align: right;"></p>
                        <button class="refresh-button" onclick="refresh()"><img src="https://upload.wikimedia.org/wikipedia/commons/7/7d/Refresh_icon.svg" style="filter: invert(100%);" /></button>
                    </div>
                </div>
            </div>
        </div>
        <% if (archiveEntries.length == 0) { %>
            <p style="text-align: center; font-weight: bold; margin-top: 2.5%; margin-bottom: 2.5%;">This archive is empty.
            <br>Click refresh to gather new entries!</p>
        <% } %>
        <div class="content-grid">
            <!-- for each item in each folder of the archive entries -->
            <% let i = 0; archiveEntries.forEach(function(item) { %>
                <% i++ %>
                <div class="content">
                    <!-- display the user information -->
                    <div class="user-box">
                        <img class="avatar-image" id=<%= "avatar-" + i %>>
                        <p class="username-text" id=<%= "user-" + i %>>
                    </div>
                    
                    <!-- display the content -->
                    <p class="content-text" id=<%= "data-" + i %>>
                    
                    <!-- display the media -->
                    <div class="image-grid">
                        <% item.mediaFiles.forEach(function(mediaFile) { 
                            if (mediaFile.endsWith(".jpg" || ".png")) { 
                                let split = mediaFile.split(".");
                                let previewImage = split[0] + "_preview." + split[1];
                        %>
                            <div class="image-grid-item">
                                <img class=media-image data-src="<%= '../datastructure/' + archiveName + '/assets/' + previewImage %>" style="width: 100%;"/>
                            </div>
                            <% } else if (mediaFile.endsWith(".mp4")) { %>
                            <div class="image-grid-item">
                                <video class=media-video autoplay muted loop style="width: 100%;" data-src="<%= '../datastructure/' + archiveName + '/assets/' + mediaFile %>" type="video/mp4"/>
                            </div>
                            <% } %>
                        <% }); %>
                    </div>

                    <!-- request the json file using the getJson() function using JQuery -->
                    <script>
                        try {
                            const path = "../datastructure/" + `<%= archiveName %>`.toString() + "/assets/" + `<%= item.informationFile %>`.toString();
                            $(document).ready($.getJSON(path, function(data) {
                                document.getElementById("avatar-" + <%= i %>).src = data.author.profile_image;
                                document.getElementById("user-" + <%= i %>).innerHTML = "@" + data.author.name;
                                document.getElementById("data-" + <%= i %>).innerHTML = data.content;
                            }));
                        } catch (error) {
                            console.log(error);
                        }
                    </script>
                </div>
            <% }); 
            %>
            <script>
                document.getElementById("entrycount").innerHTML = <%= i %> + " entries";
            </script>
        </div>
    </body>
</html>
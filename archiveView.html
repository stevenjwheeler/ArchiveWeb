<!DOCTYPE html>

<html lang="en">
  <head>
    <link rel="stylesheet" href="/assets/archiveView.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ArchiveWeb - <%= archiveName %></title>
  </head>

  <noscript>
    <div class="javascript-error-background">
      <div class="javascript-error">
        This web app requires JavaScript to be enabled in order to function
        properly.<br />
        Please enable JavaScript in your browser settings or unblock scripts,
        and try again.
      </div>
    </div>
  </noscript>

  <script
    language="JavaScript"
    type="text/javascript"
    src="/js/jquery-3.6.3.min.js"
  ></script>

  <script>
    function refresh() {
      const refreshButton = document.querySelector(".refresh-button");
      // disable the refresh button for more clicks
      refreshButton.disabled = true;
      // set the style so that it is no longer a pointer cursor
      refreshButton.style.cursor = "default";
      // remove the hover effect
      refreshButton.style.backgroundColor = "#404abe";

      // add a loading spinner to the refresh button
      refreshButton.classList.add("button-loading-spinner");

      // send a POST request to the server to refresh the archive
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/refresh-archive", true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.send(
        JSON.stringify({
          archiveName: "<%= archiveName %>",
        })
      );

      // wait for the server to respond with a 200 OK
      xhr.onreadystatechange = function () {
        if (xhr.status == 200) {
          // reload the page
          location.reload();
        }
      };
    }

    function loadAndFadeOnScroll() {
      const content = document.querySelectorAll(".content");
      const loadingtext = document.getElementById("loading-text");

      const options = {
        root: null,
        rootMargin: "0px",
        threshold: 0,
      };

      const observer = new IntersectionObserver(onIntersection, options);

      content.forEach((content) => {
        observer.observe(content);
      });

      function onIntersection(entries) {
        entries.forEach((entry) => {
          if (entry.intersectionRatio > 0) {
            // check the avatar
            const avatarImage = entry.target.querySelector(".avatar-image");

            var xhr = new XMLHttpRequest();
            xhr.open("HEAD", avatarImage.src, true);
            xhr.send();

            xhr.onreadystatechange = function () {
              if (this.readyState == this.DONE) {
                if (this.status == 404) {
                  avatarImage.src = "/assets/default-avatar.png";
                }
              }
            };

            // grab the media-image and media-video elements
            const mediaImages = entry.target.querySelectorAll(".media-image");
            const mediaVideos = entry.target.querySelectorAll(".media-video");

            // load each mediaImage and mediaVideo
            loadContent(mediaImages, mediaVideos).then(() => {
              // once the content is loaded, fade it in
              entry.target.style.visibility = "visible";
              entry.target.classList.add("fade-in");
            }),
              observer.unobserve(entry.target);
          }
        });
      }
      loadingtext.style.visibility = "hidden";
      loadingtext.style.margin = "0";
    }

    function loadContent(mediaImages, mediaVideos) {
      mediaImages.forEach((mediaImage) => {
        mediaImage.src = mediaImage.dataset.src;
        moveImages();
      });
      mediaVideos.forEach((mediaVideo) => {
        mediaVideo.src = mediaVideo.dataset.src;
      });
      return Promise.resolve();
    }

    function moveImages() {
      const imageGrid = document.querySelectorAll(".image-grid");
      var gridArray = [...imageGrid];

      gridArray.forEach((imageGrid) => {
        const imageGridItems = imageGrid.querySelectorAll(".image-grid-item");
        const numberOfImages = imageGridItems.length;

        if (numberOfImages === 1) {
          imageGrid.style.gridTemplateColumns = "1fr";
        } else if (numberOfImages === 2) {
          imageGrid.style.gridTemplateColumns = "1fr 1fr";
        } else if (numberOfImages === 3) {
          imageGrid.style.gridTemplateColumns = "1fr 1fr";
          imageGrid.style.gridTemplateRows =
            "1fr " + imageGridItems[2].clientHeight - 1 + "px";
          imageGridItems[0].style.gridColumn = "1 / 3";
        } else if (numberOfImages === 4) {
          imageGrid.style.gridTemplateColumns = "1fr 1fr";
          imageGrid.style.gridTemplateRows =
            "1fr " + imageGridItems[2].clientHeight - 1 + "px";
        } else {
          imageGrid.style.gridTemplateColumns =
            "repeat(auto-fit, minmax(150px, 1fr))";
        }

        imageGridItems.forEach((imageGridItem) => {
          // stretch the image to fit the grid
          imageGridItem.style.width = "100%";
          imageGridItem.style.height = "100%";
        });
      });
    }
  </script>

  <body onload="loadAndFadeOnScroll()">
    <div class="title-box">
      <!-- create a grid of 1 row 2 columns that has the h1 and p in one side the button and entrycount in the other -->
      <div class="title-box-grid">
        <div>
          <h1><%= archiveName %></h1>
        </div>
        <div>
          <div class="refresh-entry-info">
            <p id="entrycount" style="text-align: right"></p>
            <button class="refresh-button" onclick="refresh()">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/7/7d/Refresh_icon.svg"
                style="filter: invert(100%)"
                alt="refresh"
              />
            </button>
          </div>
        </div>
      </div>
    </div>
    <% if (archiveEntries.length == 0) { %>
    <p
      style="
        text-align: center;
        font-weight: bold;
        margin-top: 2.5%;
        margin-bottom: 2.5%;
      "
    >
      This archive is empty. <br />Click refresh to gather new entries!
    </p>
    <% } %>
    <p
      id="loading-text"
      style="text-align: center; font-weight: bold; margin-top: 2.5%"
    >
      Opening the archive...
    </p>
    <div class="content-grid">
      <!-- for each item in each folder of the archive entries -->
      <% let i = 0; archiveEntries.forEach(function(item) { %> <% i++ %>
      <div class="content">
        <!-- display the user information -->
        <div class="user-box">
          <img class="avatar-image" id="avatar-<%= i %>" alt="avatar"/>
          <p class="username-text" id="user-<%= i %>" />
        </div>

        <!-- display the content -->
        <p class="content-text" id="data-<%= i %>" />

        <!-- display the media -->
        <div class="image-grid">
          <% item.mediaFiles.forEach(function(mediaFile) { if
          (mediaFile.endsWith(".jpg" || ".png")) { let split =
          mediaFile.split("."); let previewImage = split[0] + "_preview." +
          split[1]; %>
          <div class="image-grid-item">
            <img
              class="media-image"
              data-src="<%= '../datastructure/' + archiveName + '/assets/' + previewImage %>"
              style="width: 100%"
              alt="media"
            />
          </div>
          <% } else if (mediaFile.endsWith(".mp4")) { %>
          <div class="image-grid-item">
            <video
              class="media-video"
              autoplay
              muted
              loop
              style="width: 100%"
              data-src="<%= '../datastructure/' + archiveName + '/assets/' + mediaFile %>"
              type="video/mp4"
            />
          </div>
          <% } %> <% }); %>
        </div>

        <!-- request the json file using the getJson() function using JQuery -->
        <script>
          try {
              const path = "../datastructure/" + `<%= archiveName %>`.toString() + "/assets/" + `<%= item.informationFile %>`.toString();
              $(document).ready($.getJSON(path, function(data) {
                  document.getElementById("avatar-" + <%= i %>).src = data.author.profile_image;
                  document.getElementById("user-" + <%= i %>).innerHTML = "@" + data.author.name;
                  document.getElementById("data-" + <%= i %>).innerHTML = data.content;
              }));
          } catch (error) {
              console.log(error);
          }
        </script>
      </div>
      <% }); %>
      <script>
        document.getElementById("entrycount").innerHTML = <%= i %> + " entries";
      </script>
    </div>
  </body>
</html>
